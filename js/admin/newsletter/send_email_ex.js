var productCache;var templateCache;var validator;var last_focus="add";var newsletterCache;var newsletterCount=0;function myPanelOnLoad(){productCache={};templateCache={};newsletterCache={};validator=new FormValidator();validator.add("user_category");validator.add("product_group");validator.add("product");validator.add("template");validator.add("descr","check_len(val,0,254)");validator.items.descr.checkOnEvent("keyup");$("#descr").bind("blur",function(){last_focus="descr"});validator.add("add","check_len(val,0,5000)");$("#add").bind("blur",function(){last_focus="add"});validator.items.add.checkOnEvent("keyup");validator.checkAll()}function myPagerHandler(a){on_post_error=panel_save_error;additional_accept=panel_after_save;var b=(isset(temp_vars_set.member)&&parseInt(temp_vars_set.member)>0)?temp_vars_set.member:"";load_panel(base_url+"newsletter/send_email/"+b,a,{"0":base_url+"js/admin/init.js"})}function myPanelDestructor(){delete (productCache);delete (templateCache)}function constantAdd(){insertAtCaret($("#"+last_focus).get(0),$("#constants").val());validator.items.descr.check();validator.items.add.check()}function loadProducts(){var a=$("#product_group").val();$("#product").attr("disabled","disabled");if(parseInt(a)>0){if(!isset(productCache[a])){setProgressBar($("#product"));on_post_message=messageSuccess;var b={action:"product_list"};b.group_id=a;load_message(base_url+"newsletter/send_email/",b)}else{setProductList(productCache[a])}}}function setProductList(a){$("#product").children(":gt(0)").remove();for(key in a){$("#product").append("<option value='"+key+"'>"+a[key]+"</option>")}$("#product").removeAttr("disabled")}function messageSuccess(c){var a=getTempVarsSet(false,c);if(isset(a.action)){var b=isset(a.items)?a.items:{};switch(a.action){case"product_list":productCache[a.group_id]=b;setProductList(b);setProgressBar($("#product"),false);break;case"template":setProgressBar($("#template"),false);templateCache[a.template_id]=b;setTemplate(b);break}}}function editTemplate(){if($("#edit_template:checked").length>0){var a=$("#template").val();$("#template").attr("disabled","disabled");$("#edit_template").attr("disabled","disabled");if(parseInt(a)>0){if(!isset(templateCache[a])){setProgressBar($("#template"));on_post_message=messageSuccess;var b={action:"template"};b.template_id=a;load_message(base_url+"newsletter/send_email/",b)}else{setTemplate(templateCache[a])}}}else{$("#template").removeAttr("disabled");$(".template_form").hide()}}function setTemplate(a){$("#edit_template").removeAttr("disabled");$(".template_form").show();$("#descr").val(a.descr);$("#add").val(a.add)}function addNewsletter(f){if(isset(f)){var d=$("#newsletter_list #nlrow"+f);var b=f;d.removeClass("dark");var a=d.find("td");var c=$(a[5]).find("a");$(c[0]).hide();$(c[1]).show()}else{if(isEditingNewsletter()){return}newsletterCount++;var d=$("#newsletter_list tr:first").clone();$("#newsletter_list").append(d);var b=newsletterCount;var a=d.find("td");var c=$(a[5]).find("a");$(c[0]).click(function(){addNewsletter(b)});$(c[1]).click(function(){editNewsletter(b)});$(c[2]).click(function(){removeNewsletter(b)});d.attr("id","nlrow"+b)}var e={};e.user_category=$("#user_category option:selected").val();e.group_id=$("#product_group option:selected").val();e.product_id=$("#product option:selected").val();if($("#edit_template:checked").length>0){e.template_id="0";e.subject=$("#descr").val();e.body=$("#add").val()}else{e.template_id=$("#template option:selected").val();e.subject="";e.body=""}newsletterCache[b]=e;$(a[0]).html(b+".");$(a[1]).html($("#user_category option:selected").html());$(a[2]).html($("#product_group option:selected").html());$(a[3]).html($("#product option:selected").html());$(a[4]).html(($("#edit_template:checked").length>0)?"custom":$("#template option:selected").html());d.show()}function removeNewsletter(a){$("#newsletter_list #nlrow"+a).remove();delete (newsletterCache[a])}function isEditingNewsletter(){if($("#newsletter_list tr.dark").length>0){var c=parseInt($("#newsletter_list tr.dark").attr("id").replace("nlrow",""));var d=newsletterCache[c];var b=($("#user_category").val()!=d.user_category)||($("#product_group").val()!=d.group_id)||($("#product").val()!=d.product_id);if(parseInt(d.template_id)==0){var a=($("#descr").val()!=d.subject)||($("#add").val()!=d.body)}else{var a=($("#template").val()!=d.template_id)}if(b||a){if(!confirm(temp_vars_set.cancelText)){return true}}$(".action_edit").show();$(".action_save").hide();$("#newsletter_list tr.dark").removeClass("dark")}return false}function editNewsletter(b){if(isEditingNewsletter()){return}$("#newsletter_list #nlrow"+b+" a.action_save").show();$("#newsletter_list #nlrow"+b+" a.action_edit").hide();$("#newsletter_list #nlrow"+b).addClass("dark");var a=newsletterCache[b];$("#user_category").val(a.user_category);$("#product_group").val(a.group_id);$("#product").val(a.product_id);if(a.group_id==0){$("#product_group").change()}if(parseInt(a.template_id)==0){$("#edit_template").attr("checked","true");$("#template").attr("disabled","disabled");$("#edit_template").removeAttr("disabled");$(".template_form").show();$("#descr").val(a.subject);$("#add").val(a.body)}else{$("#edit_template").removeAttr("checked");$("#edit_template").removeAttr("disabled");$("#template").removeAttr("disabled");$(".template_form").hide();$("#template").val(a.template_id)}validator.checkAll()}function sendNewsletters(a){var c=0;var d={action:"send"};for(key in newsletterCache){var e=new Array();var b=0;for(k in newsletterCache[key]){if(typeof(newsletterCache[key][k])!="function"){e[b]=newsletterCache[key][k];b++}}d["newsletter_"+c+"[]"]=e;c++}if(c==0&&!isset(a)){addNewsletter();sendNewsletters(true);$("#newsletter_list tr").remove();return}d.count=c;myPagerHandler(d)};
