var email_id=0;var email_count=0;var user_cat_list={};var product_group_list={};var product_list={};var all_emails4sending=0;var sent_emails=0;var msg=null;function recount_emails(){try{$("div[name^='email_num']").parent("div").parent("div[id!='orig']").each(function(b){b++;$(this).children("div:first-child").children("div[name='email_num']").html(b+".&nbsp;");email_count=b})}catch(a){_sys_error("send_email:recount_emails","Changes the order of all items of label to: list ",a)}}function del_email(a){try{if(a>0){$("div[id='email_to-"+a+"']").remove();email_count--;recount_emails()}}catch(b){_sys_error("send_email:del_email","Deletes item from label to: list ",b)}}function add_email(){try{email_id++;email_count++;var d=$("select#user_category").val();var b=$("select[id='product_group']").val();var h=$("select[id='product_group'] option:selected").html();var a=$("select[id='product']").val();var f=$("select[id='product'] option:selected").html();var g=$("#orig").clone();g.attr("id","email_to-"+email_id);$("#section_email_to").append(g);$(g).children("div:first-child").children("div[name='email_num']").html(email_count+".&nbsp;");$(g).children("div:first-child").children("div[name='user_cat']").html(d);$(g).children("div:first-child").children("div[name='group_id']").html(b);$(g).children("div:first-child").children("div[name='group_name']").html("&nbsp;-&nbsp;"+h);$(g).children("div:first-child").children("div[name='prod_id']").html(a);$(g).children("div:first-child").children("div[name='prod_name']").html("&nbsp;-&nbsp;"+f);$(g).children("div[name='del_email']").children("a").attr("href","javascript:del_email("+email_id+");");$("#email_to-"+email_id).css("display","")}catch(c){_sys_error("send_email:add_email","Adds item to label to: list ",c)}}function after_step1_next_success(b){_msg_panel_hide();_error_panel_hide();try{$("#content").html(b)}catch(a){_sys_error("send_email:after_step1_next_success","Shows content of sending email Step 2",a)}}function after_step1_next_error(a){_msg_panel_hide();_error_panel_hide();if(a!=""){_error_panel_show(a)}}function step1_next(){var h=new Array;var d=new Array;var c=new Array;try{_msg_panel_hide();_error_panel_hide();var a=$("#template").val();var g=$("#from").val();$("div[id^='email_to-']").each(function(j){var l=$(this).children("div:first-child").children("div[name='user_cat']").text();h.push(l);var k=$(this).children("div:first-child").children("div[name='group_id']").text();d.push(k);var e=$(this).children("div:first-child").children("div[name='prod_id']").text();c.push(e)});var f={template_id:a,from:g,"users[]":h,"p_groups_id[]":d,"products_id[]":c,action:"next"};if(_validate_step1next_fields(f)){on_post_success=after_step1_next_success;on_post_error=after_step1_next_error;load_panel(base_url+"newsletter/subscribe",f)}return}catch(b){_sys_error("send_email:step1_next","Prepare params for the next step of sending emails ",b)}}function after_send_email_success(b){_msg_panel_hide();_error_panel_hide();try{if(b=="ajax"){on_post_success=after_sending_start_success;on_post_error=after_sending_start_error;load_panel(base_url+"newsletter/send_start")}else{$("#js_msg_emails_is_enqueued").show();$("#msg_panel").show()}}catch(a){_sys_error("send_email:after_send_email_success","Load send_start",a)}}function after_send_email_error(a){_msg_panel_hide();_error_panel_hide();if(a!=""){_error_panel_show(a)}}function send_email(a){try{_msg_panel_hide();_error_panel_hide();if(a=="now"){a="ajax"}else{a="cron"}var b=$("#subject").val();var c=$("#message").val();var f={subject:b,message:c,action:a};on_post_success=after_send_email_success;on_post_error=after_send_email_error;load_panel(base_url+"newsletter/prepare",f)}catch(d){_sys_error("send_email:send_email","Gets subject and message for sending email ",d)}}function _validate_step1next_fields(b){var c=true;try{$("div#error_panel").children(".box_err").hide();$.each(b,function(d,e){if(d=="from"){if(e==""){$("#jsvalid_error_from_empty").show();$("#error_panel").show();c=false;return}if(!check_max_len(e,254)){$("#jsvalid_error_from_toolong").show();$("#error_panel").show();c=false;return}else{if(!check_mail(e)){$("#jsvalid_error_from_wrong").show();$("#error_panel").show();c=false;return}}}else{if(d=="template_id"){if(e==""){$("#jsvalid_error_template_empty").show();$("#error_panel").show();c=false;return}if(parseInt(e)<1||isNaN(e)){$("#jsvalid_error_template_wrong").show();$("#error_panel").show();c=false;return}}else{if(d=="users[]"){if(parseInt(e.length)<1){$("#jsvalid_error_users_empty").show();$("#error_panel").show();c=false;return}for(i=0;i<e.length;i=i+1){if(e[i]!="all_user"&&e[i]!="all_expired_user"&&e[i]!="all_active_user"){$("#jsvalid_error_users_wrong").show();$("#error_panel").show();c=false;return}}}else{if(d=="p_groups_id[]"){if(!c){return false}if(e.length<0){$("#jsvalid_error_pgroups_empty").show();$("#error_panel").show();c=false;return}for(i=0;i<e.length;i=i+1){if(parseInt(e[i])<0||isNaN(e[i])){$("#jsvalid_error_pgroups_wrong").show();$("#error_panel").show();c=false;return}}}else{if(d=="products_id[]"){if(!c){return false}if(e.length==0){alert("product");if(currerror!=""){return}$("#jsvalid_error_products_empty").show();$("#error_panel").show();c=false;return}for(i=0;i<e.length;i=i+1){if(parseInt(e[i])<0||isNaN(e[i])){$("#jsvalid_error_products_wrong").show();$("#error_panel").show();c=false;return}}}}}}}})}catch(a){_sys_error("send_email:validate_step1next_fields","Newsletter Send Email form fields validation",a)}return c}function after_update_template_success(b){try{_msg_panel_hide();_error_panel_hide();if(b!=""){_msg_panel_show(b)}}catch(a){_sys_error("send_email:after_update_template_success","Shows a message after successful template updating",a)}}function after_update_template_error(a){try{_msg_panel_hide();_error_panel_hide();if(a!=""){_error_panel_show(a)}}catch(b){_sys_error("send_email:after_update_template_error","Shows an error after attempt to update template",b)}}function update_template(c){_msg_panel_hide();_error_panel_hide();try{if(c>0){var f=$("#subject").val();var a=$("#message").val();var d={id:c,subject:f,message:a,action:"save"};if(_validate_template_fields(d)){on_post_success=after_update_template_success;on_post_error=after_update_template_error;load_panel(base_url+"newsletter/template_edit",d)}}}catch(b){_sys_error("send_email:update_template","Collects email fields values for updating template",b)}}function after_send_email_load_products_success(b){try{_msg_panel_hide();_error_panel_hide();if(b!=""){$("#product").html(b)}}catch(a){_sys_error("send_email:after_send_email_load_products_success","Shows product list as options collection string",a)}}function after_send_email_load_products_error(a){try{_msg_panel_hide();_error_panel_hide();if(a!=""){}}catch(b){_sys_error("send_email:after_send_email_load_products_error","Hides all panels with message and error",b)}}function send_email_load_products(){try{gid=$("#product_group").val();if(gid>=0){var b={id:gid};on_post_success=after_send_email_load_products_success;on_post_error=after_send_email_load_products_error;start_request(base_url+"newsletter/products_list",b)}}catch(a){_sys_error("send_email:send_email_load_products","Load products list for products selection",a)}};
